<!doctype html>
<html>
<head>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>tcs</title>
  <style type="text/css">

  :root{
    background-color: #333;
  }

  *{
    padding: 0;
    border: none;
    margin: 0;
		user-select: none;
  }

  html, body{
    width: min(400px, 100%);
    height: min(800px, 100%);
    background:#8fa1b1
  }

  #canvas{
    height: 100%;
  }

  #count{
    width: 1cm;
    height: 1cm;
    position: fixed;
    font-size: 32px;
    text-align: center;
    line-height: 1cm;
    pointer-events: none;
  }

</style>
</head>
<body onclick="cha_speed = -4">

<!-- 计数器 -->
<div id="count"></div>

<!-- 画布 -->
<canvas id="canvas"></canvas>

<script type="text/javascript">

var fps = 60;  //帧率 f/s
var g = 10;  //重力加速度 m/s*s
var jump_speed = 1;  //跳跃速度 m/s
var cha = [2.5, 1];  //角色位置 m
var cha_size = 0.25;  //角色大小 m
var game_size = [5, 10];  //游戏画面大小 m
var can_size = [250, 500];  //画布大小 px
var x_speed = 3;  //水平移动速度 m/s

var speed = 1000 / fps;  //画面渲染间隔  ms
var cpg = can_size[0] / game_size[0];  //画布转换率  px/m
var sp = 1 / fps;  //速度单位转换  m/fps
var cha_speed = 0;  //角色竖直速度 m/s
var wall = {"up": [], "dowm": []};  //墙
var score = 0;

//初始化墙
wall.up[0] = [0, 0];
wall.up[1] = [game_size[0], 0];
wall.dowm[0] = [0, game_size[1]];
wall.dowm[1] = [game_size[0], game_size[1]]

var count = document.getElementById('count');  //获取计数器
var canvas = document.getElementById('canvas');  //获取画布
canvas.width = can_size[0];  //设置画布宽
canvas.height = can_size[1];  //设置画布高
var ctx = canvas.getContext('2d');  //2d


//绘制
var draw = function () {

  //移动墙
  for(i = 0; i < wall.up.length; i++){
    wall.up[i][0] -= x_speed * sp;
    wall.dowm[i][0] -= x_speed * sp;
  }

  dowall();
  
  cha_speed += g * sp;  //改变速度
  cha[1] += cha_speed * sp;  //改变位置

  //y超出范围判定
  cha[1] = cha[1] > game_size[1] ? game_size[1] : cha[1];
  cha[1] = cha[1] < 0 ? 0 : cha[1];

  crash();

  //显示分数
  count.innerText = Math.floor(score);

  //清除画布
  ctx.clearRect(0, 0, can_size[0], can_size[1]);
  
  //绘制墙
  ctx.beginPath();
  ctx.fillStyle = "#9cafc0";  //A6BACC
  ctx.moveTo(wall.up[0][0] * cpg, wall.up[0][1] * cpg);
  //上墙
  for(i = 0; i < wall.up.length; i++){
    ctx.lineTo(wall.up[i][0] * cpg, wall.up[i][1] * cpg);
  }
  //下墙
  for(i = wall.dowm.length - 1; i >= 0; i--){
    ctx.lineTo(wall.dowm[i][0] * cpg, wall.dowm[i][1] * cpg);
  }
  ctx.fill();
  ctx.closePath();

  //绘制角色
  ctx.beginPath()
  ctx.fillStyle = "#D1E1E9";  //A6BACC
  ctx.arc(cha[0] * cpg, cha[1] * cpg, cha_size * cpg, 0, 2*Math.PI);
  ctx.fill();
  ctx.closePath();
}

//处理墙位置
var random_point;
function dowall(){

  //上墙墙第二个点在左屏幕左侧
  if(wall.up[1][0] < 0){
    wall.up.shift();  //删除上墙第一个点
    wall.dowm.shift();  //删除下墙第一个点
  }
  //上墙最后一个点在右屏幕左侧
  if(wall.up[wall.up.length - 1][0] < game_size[0]){
    random_point = Math.random() * game_size[1] - 2;
    wall.up.push([wall.up[wall.up.length - 1][0] + 5, random_point]);  //往上墙后加入一个点 x是最后一个点的右方5m
    wall.dowm.push([wall.dowm[wall.dowm.length - 1][0] + 5, random_point + 4]);  //往下墙后加入一个点 是上墙加的点的下方4m
  }
}

//碰撞检测
var k;  //墙壁斜率
function crash(){
  //上墙碰撞检测
  for(i = 0; i < wall.up.length - 1; i++){
    if(wall.up[i][0] <= cha[0] && wall.up[i + 1][0] > cha[0]){
      k = (wall.up[i + 1][1] - wall.up[i][1]) / (wall.up[i + 1][0] - wall.up[i][0]);
      if(k * (cha[0] - wall.up[i][0]) - (cha[1] - wall.up[i][1]) >= 0){
        score -= x_speed * sp * 5;
      }else{
        score += x_speed * sp;
      }
    }
    break;
  }
  
  //下墙碰撞检测
  for(i = 0; i < wall.dowm.length - 1; i++){
    if(wall.dowm[i][0] <= cha[0] && wall.dowm[i + 1][0] > cha[0]){
      k = (wall.dowm[i + 1][1] - wall.dowm[i][1]) / (wall.dowm[i + 1][0] - wall.dowm[i][0]);
      if(k * (cha[0] - wall.dowm[i][0]) - (cha[1] - wall.dowm[i][1]) <= 0){
        score -= x_speed * sp * 5;
      }
    }
    break;
  }
}

//按键检测
document.addEventListener('keydown',(e)=>{
  var ev = e || window.event;  //获取玩家按键  兼容
  if(ev.keyCode == 32){
    cha_speed = -4;  //按下空格键改变速度
  }
},false);

setInterval(draw, speed)

</script>
</body>
</html>
