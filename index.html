<!DOCTYPE html>
<html lang="utf-8">
<head>
	<meta charset="utf-8" />
	<meta name="description" content="Ran's blog">
	<meta name="author" content="Ran">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link rel="icon" type="image/png" href="img/Ran.png">
	<title>Ran</title>
<style type="text/css">
*{
	padding: 0;
	margin: 0;
	border: none;
	overflow: hidden;
	touch-action: none;
	user-select: none;
}
html, body{
	width: 100%;
	height: 100%;
}
#home{
	width: 100%;
	height: 100%;
}

#portrait{
	/* border-radius: 50%; */
	position: fixed;
	display: none;
}

.nav_box{
	position: fixed;
}
.nav_img{
	position: absolute;
	height: 100%;
  -ms-interpolation-mode: nearest-neighbor;
  image-rendering: pixelated;
}
.nav_title{
	position: relative;
}

iframe{
	border: 0;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	z-index: 10;
}


</style>
</head>
<body>
	
<canvas id="home"></canvas>
<img id="portrait" src="img/RanC.png" />

<script src="js/common.js"></script>
<script>
	
var theme = new mem("theme", getCookie("theme") || "#EEE");  //主题颜色
var color = getColor(theme.value);  //配色
var FPS = +getCookie("fps") || 60;  //动画帧数
var SF = +getCookie("sf") || 1;  //分辨率
var lang = +getCookie("lang") || 0;  //语言
var PI = Math.PI;
var DPI = 2 * PI;
var HPI = 0.5 * PI;
var DPR = getDevicePixelRatio() * SF;
var startTime = +new Date();
var waitTime = 10;  //10s后自动关闭加载界面
var isLoading = true;  //是否在加载界面
var iframe = {ifr: undefined, opacity: 0, aniTime: 0.2, dir: 1};
function openIframe(src){
	iframe.dir = 1;
	var ifr = document.createElement("iframe");
	iframe.ifr = ifr;
	ifr.setAttribute("frameBorder", "0");
	ifr.width = "100%";
	ifr.height = "100%";
	ifr.src = src;
	iframe.opacity = 0;
	document.body.appendChild(ifr);
}
function closeIframe(){
	iframe.dir = -1;
	var ifr = iframe.ifr;
}
window.onmessage = function(e){
	switch(e.data){
		case "closeIframe":
			closeIframe();
			break;
	}
}

var w = h = mx = my = 0;
var canvas = document.getElementById("home");
var ctx = canvas.getContext("2d");
function initCav(){
	w = canvas.clientWidth;
	h = canvas.clientHeight;
	canvas.width = w * DPR;
	canvas.height = h * DPR;
	ctx.scale(DPR, DPR);
	ctx.fillStyle = color.main;
	ctx.fillRect(0, 0, w, h);
}
initCav();
mx = 0.5 * w; my = 0.5 * h;
function pointer(e){
	e = e || window.event;
	var pos = e.touches && e.touches.length ? e.touches[0] : e;
	mx = pos.clientX || 0;
	my = pos.clientY || 0;
}
if(window.onpointermove){
	window.onpointermove = pointer;
}else{
	window.onmousemove = pointer;
}


new box("loading", {
	size: 200,  //loading大小
	ratio: 1,  //缩放倍数
	w: 0.5 * PI,  //loading旋转 角速度
	quantity: 7,  //小球数量
	r: 0.06,  //小球半径
	R: 0.3,  //大圆半径
	lw: 0.02,  //线宽
	deg: 0,  //小球旋转过的角度
	angle: new linear(0, 7, 0),  //大圆旋转角
	shaft: [new linear(1, 7, 1), new linear(0, 7, 0), 0]  //大圆旋转轴
}, {
	length: function(box){
		var minLen = w < h ? w : h;
		return (minLen < box.vars.size ? minLen : box.vars.size) * box.vars.ratio;
	},
	x: function(length){return 0.5 * (w - length)},
	y: function(length){return 0.5 * (h - length)},
}, function(delta){
	var l = this.attr.length(this);
	var x = this.attr.x(l);
	var y = this.attr.y(l);
	
	var j = this.vars;
	j.deg = (j.deg + j.w * delta) % DPI;
	var dx = mx - 0.5 * w;
	var dy = my - 0.5 * h;
	var c = Math.cos(0.5 * j.angle.value);
	var s = Math.sin(0.5 * j.angle.value);
	var shaft = [-j.shaft[1].value, j.shaft[0].value, 0]
	
	var posArray = [];
	for(var i = 0; i < j.quantity; i++){
		var alpha = j.deg + DPI * i / j.quantity;
		var oriPos = [l * j.R * Math.cos(alpha), l * j.R * Math.sin(alpha), 0];
		var u = oriPos.times(c).plus(shaft.cross(oriPos).times(s));
		var pos = shaft.times(s * s * shaft.dot(oriPos)).plus(u.times(c)).plus(shaft.cross(u).times(s));
		posArray[i] = pos;
	}
	posArray.sort(function(a, b){ return a[2] - b[2] });
	var deep = posArray[j.quantity - 1][2] - posArray[0][2];
	for(var i = 0; i < j.quantity; i++){
		ctx.beginPath();
		var e = 1 + 0.3 * posArray[i][2] / (deep || 1e-5);
		ctx.arc(w * 0.5 + posArray[i][0], h * 0.5 + posArray[i][1], l * j.r * e, 0, DPI);
		ctx.fillStyle = color.main;
		ctx.strokeStyle = color.anti;
		ctx.lineWidth = j.lw * l;
		// Object.assign(ctx, {fillStyle: color.main, strokeStyle: color.anti, lineWidth: j.lw * l});
		ctx.fill();
		ctx.stroke();
		ctx.closePath();
	}
	
	var shaftFinal = [dx, dy].norm(1e-5);
	j.shaft[0].setFinal(shaftFinal[0]).run(delta); j.shaft[1].setFinal(shaftFinal[1]).run(delta);
	var shaftValue = [j.shaft[0].value, j.shaft[1].value].norm(1e-5);
	j.shaft[0].value = shaftValue[0]; j.shaft[1].value = shaftValue[1];
	j.angle.setFinal(DPI * [dx, dy].abs() / ([w, y].abs() || 1e-5)).run(delta);
	
}, function(box){
	
});
	

//画面渲染
var time = 0;
function render(){
	//判断帧间隔
	let newTime = +new Date();
	var delta = 1 / FPS;
	if(time) delta = (newTime - time) * 0.001;
	time = newTime;
	
	//自动关闭加载界面
	if(isLoading && (newTime - startTime) * 1e-3 > waitTime && window.onload){
		//window.onload();
	}
	
	//判断主题是否改变
	theme.get(function(){color = getColor(theme.value)});
	
	//初始化画布
	initCav();
	
	//处理iframe
	if(iframe.ifr){
		iframe.opacity += delta / iframe.aniTime * iframe.dir;  //iframe透明度
		iframe.ifr.style.opacity = iframe.opacity;
		if(iframe.opacity >= 1){  //完全进入iframe 停止渲染主页
			iframe.opacity = 1;
			return ;
		}else if(iframe.opacity <= 0){  //完全退出iframe 删除iframe
			if(iframe.ifr && iframe.ifr.parentNode) iframe.ifr.parentNode.removeChild(iframe.ifr);
			iframe.ifr = undefined;
			iframe.opacity = 0;
		}
	}
	
	//渲染box
	for(var key in boxs){
		boxs[key].fn(delta);
	}

}

// setInterval(render, 1000);
setInterval(render, 1000 / FPS);

</script>
<script src="js/ui.js"></script>
<script>
window.onload = function(){
	ui_homeAL();
	isLoading = false;
};
</script>
</body>
</html>





